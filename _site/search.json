[
  {
    "objectID": "about.html",
    "href": "about.html",
    "title": "About",
    "section": "",
    "text": "I’m Sarah Pan. I work on AI/ML stuff and occasionally write about things I find interesting.\nThis blog is called “rabbitholes” because I tend to get sucked into random technical topics and spend way too much time exploring them.\nFeel free to reach out on Twitter or GitHub."
  },
  {
    "objectID": "posts/titan-llama/index.html",
    "href": "posts/titan-llama/index.html",
    "title": "Titan-LLaMA: Neural Memory Adapters for Continual Learning",
    "section": "",
    "text": "Warning\n\n\n\nThis work was submitted as our final project for Deep Learning at MIT (6.7960). Much of the results are still preliminary and poorly ablated as work is ongoing."
  },
  {
    "objectID": "posts/titan-llama/index.html#motivation",
    "href": "posts/titan-llama/index.html#motivation",
    "title": "Titan-LLaMA: Neural Memory Adapters for Continual Learning",
    "section": "Motivation",
    "text": "Motivation\nWe read the Titans paper and really liked it, but we didn’t want to train an end-to-end architecture from scratch. So instead, we came up with a new architecture that gives us the best of both worlds.\nOff-the-shelf LLMs are extremely strong, but their expressivity is expensive as “memory” grows quadratically with sequence length. Among many others, Flash attention, sliding attention windows, linear attention, and KV-caching are techniques that provide speedups, but we were curious to know if we could attach a learned state during post training for stateful, sub-quadratic memory.\nTitans is appealing in this regard because its memory is a deep architecture that accumulates information across full-attention segments. Rather than training a Titan model from scratch, we treat neural memory as a modular adapter that can be attached to a pretrained backbone whose long-range attention has been intentionally restricted.\nConcretely, we freeze a pretrained LLaMA model, replace full attention with segmented attention, and attach a Titans-style Neural Memory Module (NMM) that serves as the sole mechanism for cross-segment information flow. The memory module functions as a drop-in “cartridge” that can be trained or swapped independently while the backbone remains fixed. To our knowledge, this is the first exploration of Titans-style neural memory used in this post-training, frozen-backbone regime.1 The result is an architecture that (i) generates tokens much faster as generation length grows and (ii) can be fine-tuned by swapping in task-specific memory adapters for downstream domains.\n\n\n\nToken throughput vs. generation length. Full-attention LLaMA slows down as sequences grow, while segmented attention keeps throughput roughly flat; we’ll keep you posted if either of us learns enough CUDA to engineer kernels for this.\n\n\n\n\n\n\n\n\nNote\n\n\n\nOur prototype builds on an existing open-source Titans implementation that prioritizes correctness.2 The neural memory kernels are probably under-optimized, introducing overhead that causes throughput to lag slightly behind full attention in practice. We consider this an engineering issue and expect substantial speedups from better implementation."
  },
  {
    "objectID": "posts/titan-llama/index.html#background",
    "href": "posts/titan-llama/index.html#background",
    "title": "Titan-LLaMA: Neural Memory Adapters for Continual Learning",
    "section": "Background",
    "text": "Background\nOur inspiration for this work falls into two categories.\nMemory and state. RNNs and LSTMs compress history into a fixed-size hidden vector but eventually forget distant information and cannot be parallelized. SSMs (Gu, Goel, and Ré 2021) revisit this idea by improving stability and parallelizability. Transformers on the other hand store the entire sequence explicitly, relying on an attention “state” that grows quadratically with sequence length. For the record, we think it’s totally understated how extremely parallelizable and expressive transformers are–but mitigating memory consumption is still a key concern.\nParameter-efficient adapters. Full fine-tuning is expensive and risks catastrophic forgetting. LoRA (Hu et al. 2021) instead adds trainable low-rank factors to frozen weight matrices, which reduces the trainable parameters by orders of magnitude while preserving expressivity. Prefix-tuning (Li and Liang 2021) prepends learned continuous prompts to the input sequence, allowing the model to behave as if conditioned on specific tasks or domains while keeping the backbone frozen.\n\nTitans: Deep Neural Memory as State\nTitans: deep neural memory as state. Titans (Behrouz et al. 2024) combines recurrent architectures as long-term memory with localized attention windows as short-term memory. These were the three things that we thought were the most important to understand from the paper.\n1. Titans as a Mega-Abstraction of LSTMs. Each cell state is a sub-sequence of tokens, but instead of forget gates and input gates, an MLP learns how to incorporate/get rid of information across a sequence. In other words, instead of carrying some \\(h_t\\) forward, Titans carry a long-term memory module \\(M_t\\) whose weights + fast gradient updates determine the state.\n\n\n\nReading from memory looks like “querying the state” via a forward pass, and updating the state looks like propgating a loss backward.\n\n\n2. Fast and Slow Updates. Long-term memory aims to memorize what happened at a previous attention window. Titans defines a “fast” memory loss \\(l(\\mathcal{M}_{t -1}; x_t) = || q_t - k_t ||^2\\) and updates its state over chunks in a sequence as such\n\\[\n\\mathcal{M}_t = (1 - \\alpha_t) \\mathcal{M}_{t - 1} + S_t \\\\\n\\tag{1}\\] \\[\nS_t = \\eta_t S_{t - 1} - \\theta_t \\nabla l(\\mathcal{M}_{t -1}; x_t).\n\\]\nThe surprise update rule is shown in Equation 1. Here, \\(\\alpha_t\\) serves as the gating mechanism, like that in RNNs.\nOn the flip side, we still care about the language modeling objective and want to update the weights that parameterize \\(\\mathcal{M}_t\\) to optimize retrieval of the right information. These are the “slow updates” that operate on the timescale of our optimizer.\n3. This Can be Made Practical. A naive implementation of these per-token weight updates is inherently sequential, but with a few tricks, you can actually vectorize much of the computation. If chunks within a sequence have length b and hidden size d, the rest of the computation is described as such:\n# X: [N, b, d]   (N chunks of b tokens)\nu_prev = 0                      # last \"update\" state for this param (shape = param_shape)\nm_prev[o] = 0 for o in 1..O     # last momentum states\n\nfor t in range(N):\n    # 1) FAST write signal inside the chunk (parallel over b tokens)\n    #    think: per-token grad of an associative loss wrt memory params\n    s_tok = grad_mem_loss(M, X[t])            # shape: [b, param_shape]   (conceptually)\n\n    # (optional) reduce tokens -&gt; one chunk surprise (still parallel)\n    s = sum_i theta[t,i] * s_tok[i]           # shape: [param_shape]\n\n    # 2) SLOW accumulator across chunks (scan in t)\n    for o in 1..O:\n        m[o] = eta[o,t] * m_prev[o] + (s if o==1 else m[o-1])\n\n    u = sum_o comb[o,t] * m[o]                # (this is the “einsum combine orders” idea)\n\n    # 3) FORGET/DECAY across chunks (another scan)\n    u = (1 - alpha[t]) * u_prev + u\n\n    apply_update_to_memory(M, u)              # e.g., M &lt;- M + u   (sign convention depends)\n    u_prev, m_prev = u, m"
  },
  {
    "objectID": "posts/titan-llama/index.html#methods",
    "href": "posts/titan-llama/index.html#methods",
    "title": "Titan-LLaMA: Neural Memory Adapters for Continual Learning",
    "section": "Methods",
    "text": "Methods\nOur perspective: We combine these views by attaching Titan-style memory to a frozen LLaMA backbone and treating it as a cartridge-style adapter. The backbone stays fixed; only the Titan memory continues learning.\n\n\n\nThe NMM (green) injects cross-segment attention entries, allowing information retrieval across segment boundaries without full-sequence attention.\n\n\nThe next step of the process is to augment the localized attention calculation with “long-term memory” that is retrieved from the NMM. The NMM will try to recall what happened at the previous local attention window.\n\n\n\nAs chunks c1–c5 progress, the NMM is queried then updated based on prediction error, making information persistent across the full sequence.\n\n\nIt might be helpful to “flip” the time axis when thinking about the fast update process. If we imagine each localized attention segment to be its own element in a sequence, this process closely resembles that of an LSTM or RNN. However, instead of learning weights that modulate previous hidden cell states, the hidden state itself is parameterized as a deep, learned architecture.\nBy storing the gradients for the surprisal-based loss, our neural memory module is essentially trained to remember all the prior attention outputs.\n\n\n\nPurple: frozen LLaMA. Green: trainable NMM + fast gradients. Only the memory “cartridge” adapts. The backbone is completely frozen: only ~2% of parameters are trainable.\n\n\nFinally, we propagate the language modeling loss over the weights of the NMMs and actually perform weight updates. It’s important to note here that the rest of the weights in the pre-trained backbone are frozen and no updates are made to them. We can think of these “slow updates” as teaching the NMMs how to recall best.\n\nAttention Distillation Loss\nIn practice, we noticed that the pure language modeling objective was really easy for NMMs to master. And in fact, we do much better than our out-of-the-box LLM when evaluating next token prediction purely on a token accuracy / perplexity basis. However, when it came to the challenging language benchmarks that pre-trained LLMs excel at, solely using the language modeling loss was insufficient.\nIn our setting, we want the NMM to first recover baseline capabilities of the backbone LLM. We supervise the outputs of the Titan-agumented layers with that from our pre-trained backbone. In effect, we implicitly distill the expressivity from our pre-trained “teacher attention” into our adapter’s recollection strategy only using a single additional forward pass at train-time.\n\n\n\n\n\n\nCalculating Attention Distillation Loss\n\n\n\n\nCompute normal forward pass\n\nCollect hidden states, these are “student” latents\n\nDo a forward pass over the backbone, without segmented attn\n\nCollect hidden states, these are “teacher” latents\n\nCompute MSE over these latents, scale, and add to LM loss"
  },
  {
    "objectID": "posts/titan-llama/index.html#experiments",
    "href": "posts/titan-llama/index.html#experiments",
    "title": "Titan-LLaMA: Neural Memory Adapters for Continual Learning",
    "section": "Experiments",
    "text": "Experiments\nHypothesis: A Titans-style neural memory, used as an adapter on top of a frozen LLM backbone, can\n(1) recover backbone LLM capabilities\n(2) and be fine-tuned to specialize in new domains.\nExperiment 1: Can Titan-LLaMA recover base LM abilities?\nWe test whether the NMM can compensate for the information lost when replacing full attention with cheap segmented attention.\n1a. Language Modeling: Train the Titan-LLaMA adapter on 1B tokens from SlimPajama-627B and FineWeb-EDU. Report validation perplexity and token accuracy.\n1b. NLP Benchmarks: Evaluate on Winogrande (Sakaguchi et al. 2020), BoolQ (Clark et al. 2019), CommonsenseQA (Talmor et al. 2018), DROP (Dua et al. 2019), SQuAD (Rajpurkar et al. 2016), and PubMedQA (Jin et al. 2019). Compare against frozen LLaMA (full attention) and segmented-only (ablation).\nExperiment 2: Domain Adaptation\nCan we train domain-specific NMMs that specialize to new areas?\n\nBiomed: PubMed corpus, PubMedQA (Jin et al. 2019)\nLegal: LexGLUE benchmark (Chalkidis et al. 2021)\nMath: AQUA-RAT word problems (Ling et al. 2017)"
  },
  {
    "objectID": "posts/titan-llama/index.html#results",
    "href": "posts/titan-llama/index.html#results",
    "title": "Titan-LLaMA: Neural Memory Adapters for Continual Learning",
    "section": "Results",
    "text": "Results\n\nExperimental Setup\nWe use Llama-3.1-8b as our pre-trained LLM backbone. For the NMMs, we attach 2-layer MLPs, with hidden dimension 2048 onto layers 4, 8, 12, 16, and 20. We use an attention segment length half the size of the data sequence length, a neural memory segment length of 64, and a neural memory batch size of 64.\nFor pre-training data, we use a 1b-token mixture of Slim Pajama and FineWeb-EDU. We fine-tune on the training sets of PubMedQA, CaseHOLD, AQUA-RAT.\nWe find that higher neural learning rates (on the order of 1e-3) are helpful to performance. Gradient updates are performed with a learning rate of 3e-4 with a linear warmup and cosine annealing. Further, we weigh the distillation loss at 0.6 relative to language modeling loss. Due to the scope of the project, we were unable to thoroughly vet our hyperparameter setup–further work will explore annealing distillation loss weight and more tuning.\n\n\nExperiment 1 Results\nWe verified that imparing attention masks led to catastrophic results. Performance of Llama-Titan exceeded that of the frozen backbone on next-token prediction / language modeling.\n\n\n\nModel\nToken Accuracy\nPerplexity\n\n\n\n\nFull-Attention LLaMA\n55.2%\n7.26\n\n\nSegmented-only (no NMM)\n0%\n1,516,042\n\n\nTitan-LLaMA (Segmented + NMM)\n100%\n~1.0\n\n\n\nThe NMM not only recovers but actually exceeds baseline language modeling metrics—achieving 100% token accuracy vs. 55.2% for the original model. This suggests the NMM learns an effective compression of the training distribution.\nThis result validates the first part of our hypothesis—the NMM can recover capabilities lost to segmentation, at least for the language modeling objective. However, perfect scores (100% accuracy, ~1.0 perplexity) suggest possible overfitting to the training distribution rather than true generalization. This motivates our next experiment: do these gains transfer to downstream benchmarks?\nBuilding on the language modeling success, we add attention distillation (described in Methods) to transfer rich representations to downstream tasks, and we achieve the following results:\n\n\n\n\n\n\n\n\n\nBenchmark\nFull-Attn LLaMA\nSegmented-only\nTitan-LLaMA (LM loss)\n\n\n\n\nWinogrande\n60.5%\n48.4%\n52.3% (+3.9%)\n\n\nBoolQ\n75.0%\n43%\n63% (+20%)\n\n\nCommonsenseQA\n75.0%\n13%\n18% (+5%)\n\n\nDROP\n59.5%\n0%\n7.4% (+7.4%)\n\n\nSquadV2\n77%\n0%\n6.25% (+6.25%)\n\n\n\nWe therefore conclude that LM loss alone teaches the NMM to predict tokens, but not to build the rich intermediate representations that full attention provides. Attention distillation forces the NMM’s hidden states to match the teacher model’s representations, which is necessary for successful downstream task performance.\n\n\n\n\n\n\nNote\n\n\n\nNote that only Winogrande and BoolQ were properly hyperparameter-tuned; for the other tasks we only ran ~30 training steps3, so their scores are very under-optimized.\n\n\nThese results partially validate our hypothesis. The NMM does recover some benchmark performance (e.g., BoolQ improves by 20 percentage points over segmented-only), but does not fully match the frozen backbone. This gap could come from several factors… limited hyperparameter tuning, insufficient training compute, suboptimal NMM architecture choices (e.g., 2-layer MLPs may be too shallow), or potentially fundamental capacity limitations of the approach. Disentangling these factors would require more extensive ablations. The consistent improvement from distillation does confirm that representation quality, not just next-token prediction, is critical for downstream tasks.\n\n\nExperiment 2 Results\nDomain-specific fine-tuning. We fine-tuned Titan-LLaMA on 3 domain-specific tasks:\n\n\n\n\n\n\n\n\n\nBenchmark\nFull-Attn LLaMA\nSegmented-only\nTitan-LLaMA (fine-tuned)\n\n\n\n\nPubMedQA (Biomed)\n58%\n46%\n55%\n\n\nCaseHOLD (Legal)\n33%\n19%\n23%\n\n\nAQUA-RAT (Math)\n28%\n22%\n24.8%\n\n\n\nThese results validate the second part of our hypothesis—the NMM can be fine-tuned to specialize in new domains. The varying recovery rates (75% for PubMedQA vs. 29% for CaseHOLD) suggest that some domains are easier to compress into learned memory than others.\nPubMedQA shows the strongest recovery, closing 75% of the gap between segmented-only and full attention (from 46% to 55%, vs. 58% full attention). CaseHOLD and AQUA-RAT show more modest but still meaningful improvements.4"
  },
  {
    "objectID": "posts/titan-llama/index.html#limitations-and-future-work",
    "href": "posts/titan-llama/index.html#limitations-and-future-work",
    "title": "Titan-LLaMA: Neural Memory Adapters for Continual Learning",
    "section": "Limitations and Future Work",
    "text": "Limitations and Future Work\n1) Incomplete recovery. Even with distillation, we don’t fully recover full-attention performance on most benchmarks. The gap suggests that some information encoded in full attention is fundamentally difficult to compress into a learned memory module. Future work could explore larger NMM architectures or different distillation strategies.\n2) Throughput overhead. Our current NMM implementation introduces computational overhead that negates the theoretical efficiency gains of segmented attention. As shown in Figure 1, the segmented+NMM model currently underperforms full attention in throughput. Optimized GPU and better memory management could address this.\n3) Limited hyperparameter tuning. Due to compute and time constraints, only Winogrande and BoolQ were thoroughly tuned. Other benchmarks (CommonsenseQA, DROP, SQuAD) ran for ~30 training steps, so their scores are likely under-optimized. More extensive sweeps could improve results. We are particularly excited about distillation loss annealing.\n4) Scale. All experiments use LLaMA-3.1-8B. We would like to test whether our findings generalize to larger models where the capacity gap between NMM and full attention may be more or less pronounced.\n5) Future directions. Promising next steps include: (1) training NMMs from distillation alone without LM loss, (2) exploring different NMM architectures beyond 2-layer MLPs, (3) investigating whether NMMs can enable genuine continual learning without catastrophic forgetting, and (4) scaling to longer sequences where the efficiency benefits of segmentation become more pronounced."
  },
  {
    "objectID": "posts/titan-llama/index.html#references",
    "href": "posts/titan-llama/index.html#references",
    "title": "Titan-LLaMA: Neural Memory Adapters for Continual Learning",
    "section": "References",
    "text": "References\n\n\nBehrouz, Ali, Mahdyar Bondaschi, Mehrdad Farhadi, Michael Horton, and Arno Blaas Cremers. 2024. “Titans: Learning to Memorize at Test Time.” arXiv Preprint arXiv:2501.00663.\n\n\nChalkidis, Ilias, Abhik Jana, Dirk Hartung, Michael Bommarito, Ion Androutsopoulos, Daniel Katz, and Nikolaos Aletras. 2021. “LexGLUE: A Benchmark Dataset for Legal Language Understanding in English.” arXiv Preprint arXiv:2110.00976.\n\n\nClark, Christopher, Kenton Lee, Ming-Wei Chang, Tom Kwiatkowski, Michael Collins, and Kristina Toutanova. 2019. “BoolQ: Exploring the Surprising Difficulty of Natural Yes/No Questions.” arXiv Preprint arXiv:1905.10044.\n\n\nDua, Dheeru, Yizhong Wang, Pradeep Dasigi, Gabriel Stanovsky, Sameer Singh, and Matt Gardner. 2019. “DROP: A Reading Comprehension Benchmark Requiring Discrete Reasoning over Paragraphs.” arXiv Preprint arXiv:1903.00161.\n\n\nGu, Albert, Karan Goel, and Christopher Ré. 2021. “Efficiently Modeling Long Sequences with Structured State Spaces.” arXiv Preprint arXiv:2111.00396.\n\n\nHu, Edward J, Yelong Shen, Phillip Wallis, Zeyuan Allen-Zhu, Yuanzhi Li, Shean Wang, Lu Wang, and Weizhu Chen. 2021. “LoRA: Low-Rank Adaptation of Large Language Models.” arXiv Preprint arXiv:2106.09685.\n\n\nJin, Qiao, Bhuwan Dhingra, Zhengping Liu, William Cohen, and Xinghua Lu. 2019. “PubMedQA: A Dataset for Biomedical Research Question Answering.” arXiv Preprint arXiv:1909.06146.\n\n\nLi, Xiang Lisa, and Percy Liang. 2021. “Prefix-Tuning: Optimizing Continuous Prompts for Generation.” arXiv Preprint arXiv:2101.00190.\n\n\nLing, Wang, Dani Yogatama, Chris Dyer, and Phil Blunsom. 2017. “Program Induction by Rationale Generation: Learning to Solve and Explain Algebraic Word Problems.” arXiv Preprint arXiv:1705.04146.\n\n\nRajpurkar, Pranav, Jian Zhang, Konstantin Lopyrev, and Percy Liang. 2016. “Squad: 100,000+ Questions for Machine Comprehension of Text.” arXiv Preprint arXiv:1606.05250.\n\n\nSakaguchi, Keisuke, Ronan Le Bras, Chandra Bhagavatula, and Yejin Choi. 2020. “Winogrande: An Adversarial Winograd Schema Challenge at Scale.” Proceedings of the AAAI Conference on Artificial Intelligence 34 (05): 8732–40.\n\n\nTalmor, Alon, Jonathan Herzig, Nicholas Lourie, and Jonathan Berant. 2018. “Commonsenseqa: A Question Answering Challenge Targeting Commonsense Knowledge.” arXiv Preprint arXiv:1811.00937."
  },
  {
    "objectID": "posts/titan-llama/index.html#bibliography",
    "href": "posts/titan-llama/index.html#bibliography",
    "title": "Titan-LLaMA: Neural Memory Adapters for Continual Learning",
    "section": "Bibliography",
    "text": "Bibliography\nLi and Liang (2021) Xiang Lisa Li and Percy Liang (2021). Prefix-Tuning: Optimizing Continuous Prompts for Generation. arxiv preprint arXiv:2101.00190\nHu et al. (2021) Hu, E. J., Shen, Y., Wallis, P., Allen-Zhu, Z., Li, Y., Wang, S., & Chen, W. (2021). LoRA: Low-Rank Adaptation of Large Language Models. arXiv preprint arXiv:2106.09685.\n(hewitt2024cartridges?) Hewitt, J., et al. (2024). Cartridges: Compact Representations for LLM Reasoning. arXiv preprint arXiv:2506.06266.\nGu, Goel, and Ré (2021) Gu, A., Goel, K., & Ré, C. (2021). Efficiently Modeling Long Sequences with Structured State Spaces. arXiv preprint arXiv:2111.00396.\nBehrouz et al. (2024) Behrouz, A., et al. (2024). Titans: Learning to Memorize at Test Time. Google Research. arXiv preprint arXiv:2501.00663.\nSakaguchi et al. (2020) Sakaguchi, K., et al. (2019). WinoGrande: An Adversarial Winograd Schema Challenge at Scale. arXiv preprint arXiv:1907.10641.\nClark et al. (2019) Clark, C., et al. (2019). BoolQ: Exploring the Surprising Difficulty of Natural Yes/No Questions. arXiv preprint arXiv:1905.10044.\nTalmor et al. (2018) Talmor, A., et al. (2018). CommonsenseQA: A Question Answering Challenge Targeting Commonsense Knowledge. arXiv preprint arXiv:1811.00937.\nDua et al. (2019) Dua, D., et al. (2019). DROP: A Reading Comprehension Benchmark Requiring Discrete Reasoning. arXiv preprint arXiv:1903.00161.\nRajpurkar et al. (2016) Rajpurkar, P., et al. (2016). SQuAD: 100,000+ Questions for Machine Comprehension of Text. arXiv preprint arXiv:1606.05250.\nJin et al. (2019) Jin, Q., et al. (2019). PubMedQA: A Dataset for Biomedical Research Question Answering. arXiv preprint arXiv:1909.06146.\nChalkidis et al. (2021) Chalkidis, I., et al. (2021). LexGLUE: A Benchmark Dataset for Legal Language Understanding. arXiv preprint arXiv:2110.00976.\nLing et al. (2017) Ling, W., et al. (2017). AQUA-RAT: Algebra Question Answering Dataset. GitHub repository.\n(behrouz2025podcast?) Behrouz, A. (2025). Cognitive Revolution podcast. YouTube."
  },
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Rabbitholes",
    "section": "",
    "text": "Hi! These are the physical artifacts of projects I’ve worked on recently. Contact at [first name][last name]@mit.edu."
  },
  {
    "objectID": "index.html#recent-posts",
    "href": "index.html#recent-posts",
    "title": "Rabbitholes",
    "section": "Recent Posts",
    "text": "Recent Posts"
  },
  {
    "objectID": "posts/titan-llama/index.html#footnotes",
    "href": "posts/titan-llama/index.html#footnotes",
    "title": "Titan-LLaMA: Neural Memory Adapters for Continual Learning",
    "section": "Footnotes",
    "text": "Footnotes\n\n\nMaybe for good reason? The motivation is clear from a Titan-first perspective, perhaps less so from a Transformers-first one.↩︎\nThanks to Phil Wang and other contributors for https://github.com/lucidrains/titans-pytorch !!↩︎\nbecause we were running late to formal↩︎\nAgain, these were super rushed experiments.↩︎"
  }
]